using System;
using System.Data;
using System.Configuration;
using System.Collections.Generic;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;

using Shared.NHibernateDAL;
using Marinha.Business;
using Shared.SessionState;
using Shared.Common;

public partial class frmLicitacaoFinalizacao : MarinhaPageBase
{

    #region Private Member
    [TransientPageState]
    protected Licitacao _licitacao;

    #endregion 

    #region Initialization
    protected override void OnInit(EventArgs e)
    {
        base.OnInit(e);
        this.btnFinalizar.Click += new EventHandler(btnFinalizar_Click);
        this.dgItem.ItemDataBound += new DataGridItemEventHandler(dgItem_ItemDataBound);
    }
	
    protected void Page_Load(object sender, EventArgs e)
    {
        if (!this.IsPostBack)
        {
        	FillPage();
            if (Request["ID_Licitacao"] != null)
            {
                _licitacao = Licitacao.Get(Convert.ToInt32(Request["ID_Licitacao"]));
                PopulateFields();
            }
            else
            {
                _licitacao = new Licitacao();
            }
            Anthem.AnthemClientMethods.Redirect("frmLicitacaoFinalizacaoPesquisa.aspx", btnVoltar);
            Anthem.AnthemClientMethods.Popup(btnNovoFornecedor, "../cadastro/frmFornecedorCadastro.aspx?popup=true", false, false, false, true, true, true,
            true, 10, 50, 770, 500, false);
            
        }
    }

    private void FillPage()
	{
	}

    #endregion

    private void PopulateFields()
    {
        txtDataPregao.Text = ObjectReader.ReadDate(_licitacao.DataPregao);
        txtNumeroPregao.Text = _licitacao.NumeroPregao;

        dgItem.DataSource = _licitacao.Itens;
        dgItem.DataKeyField = "ID";
        dgItem.DataBind();
    }

    private void FillObject()
    {
        _licitacao.DataPregao = PageReader.ReadDate(txtDataPregao);
        _licitacao.NumeroPregao = txtNumeroPregao.Text;

        foreach (DataGridItem item in dgItem.Items)
        {
            if(item.ItemType == ListItemType.AlternatingItem || item.ItemType == ListItemType.Item)
            {
                int id = Convert.ToInt32(dgItem.DataKeys[item.ItemIndex]);
                LicitacaoItem itemLicitacao = _licitacao.Itens.Find(id);

                DropDownList ddlFornecedor = (DropDownList)item.FindControl("ddlFornecedor");
                Anthem.NumericTextBox txtValorFinal = (Anthem.NumericTextBox)item.FindControl("txtValorFinal");

                itemLicitacao.Fornecedor = Fornecedor.Get(Convert.ToInt32(ddlFornecedor.SelectedValue));
                itemLicitacao.ValorFinalPregao = Convert.ToDecimal(txtValorFinal.Text);
            }
        }
    }

    private Dictionary<int, string> _listFornecedor;
    void dgItem_ItemDataBound(object sender, DataGridItemEventArgs e)
    {
        if(e.Item.ItemType == ListItemType.AlternatingItem || e.Item.ItemType == ListItemType.Item)
        {
            DropDownList ddlFornecedor = (DropDownList) e.Item.FindControl("ddlFornecedor");
            
            if(_listFornecedor == null)
                _listFornecedor = Fornecedor.List();
            
            Util.FillDropDownList(ddlFornecedor, _listFornecedor, ESCOLHA_OPCAO);
        }
    }
    
    #region Events 
    void btnFinalizar_Click(object sender, EventArgs e)
    {
        FillObject();
        _licitacao.Finalizar();	
		ShowSuccessMessage();
    }
    #endregion
    
    [Anthem.Method]
    public void FornecedorAdicionado(string id, string razaoSocial)
    {
        foreach (DataGridItem item in dgItem.Items)
        {
            if (item.ItemType == ListItemType.AlternatingItem || item.ItemType == ListItemType.Item)
            {
                Anthem.DropDownList ddlFornecedor = (Anthem.DropDownList)item.FindControl("ddlFornecedor");
                ddlFornecedor.Items.Add(new ListItem(razaoSocial, id));
                ddlFornecedor.UpdateAfterCallBack = true;    
            }
        }
    }
}
