using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Drawing;
using System.Text;
using System.Web;
using System.Collections.Generic;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;

using Marinha.Business;
using Shared.SessionState;
using ComponentArt.Web.UI;
using Shared.Common;

public partial class frmAutorizacaoCompraBaixa : SortingPageBase
{
    protected AutorizacaoCompra _ac
    {
        get { return Session["frmAutorizacaoCompraPendente._ac"] == null ? null : (AutorizacaoCompra)Session["frmAutorizacaoCompraPendente._ac"]; }
        set { Session["frmAutorizacaoCompraPendente._ac"] = value; }
    }
    
    #region Initialization
    protected override void OnInit(EventArgs e)
    {
        base.OnInit(e);
		this.RegisterSortingControl(this.gvPesquisa);
        this.gvPesquisa.RowDataBound += new GridViewRowEventHandler(gvPesquisa_RowDataBound);
        this.gvPesquisa.RowEditing += new GridViewEditEventHandler(gvPesquisa_RowEditing);
        this.ucBaixaAC.BaixaInformada += new EventHandler(ucBaixaAC_BaixaInformada);
        this.ucBaixaAC.OperacaoCancelada += new EventHandler(ucBaixaAC_OperacaoCancelada);
        btnPesquisar.Click += new EventHandler(btnPesquisar_Click);
    }
   

    protected void Page_Load(object sender, EventArgs e)
    {
        if (!this.IsPostBack)
        {
            Anthem.Manager.Register(this);
        }
    }
    #endregion  
    
    void btnPesquisar_Click(object sender, EventArgs e)
    {
        Bind();
    }
  
    protected override void Bind()
    {
        List<AutorizacaoCompra> list = AutorizacaoCompra.SelectACPendentePagamento(
            txtTexto.Text,
            IsNull(txtDataInicio.Text, DateTime.MinValue),
            IsNull(txtDataFim.Text, DateTime.MinValue));
		this.Sort(list);
		gvPesquisa.DataSource = list;
		gvPesquisa.DataKeyNames = new string[]{"ID"};
        gvPesquisa.DataBind();
        gvPesquisa.UpdateAfterCallBack = true;
        Anthem.AnthemClientMethods.ResizeIFrame();

        gvPesquisa.Visible = list.Count > 0;
        pnMensagem.Visible = list.Count == 0;
        pnMensagem.UpdateAfterCallBack = true;
    }


    void gvPesquisa_RowEditing(object sender, GridViewEditEventArgs e)
    {
        int id = Convert.ToInt32(gvPesquisa.DataKeys[e.NewEditIndex]["ID"]);
        
        _ac = AutorizacaoCompra.Get(id);
        ucBaixaAC.Show(_ac);
        
    }

    void gvPesquisa_RowDataBound(object sender, GridViewRowEventArgs e)
    {
        if (e.Row.RowType == DataControlRowType.DataRow)
        {
            AutorizacaoCompra ac = (AutorizacaoCompra)e.Row.DataItem;

            if (ac.Status.StatusAutorizacaoCompraEnum == StatusAutorizacaoCompraEnum.Reprovado)
            {
                e.Row.ForeColor = Color.Red;
                e.Row.ToolTip = ac.UltimoHistorico.Justificativa;

                e.Row.Attributes.Add("onmouseover", string.Format("Tip('<b>Justificativa:</b><br><br>{0}', SHADOW, true, PADDING, 7, FOLLOWMOUSE, false);",

                ac.UltimoHistorico.Justificativa));
            }


            if (ac.UltimoHistorico != null && ac.UltimoHistorico.FlagReprovado)
            {
                e.Row.ForeColor = Color.Red;
                e.Row.ToolTip = ac.UltimoHistorico.Justificativa;

                e.Row.Attributes.Add("onmouseover", string.Format("Tip('<b>Justificativa:</b><br><br>{0}', SHADOW, true, PADDING, 7, FOLLOWMOUSE, false);",
                    ac.UltimoHistorico.Justificativa));
            }
        }
    }

    #region Baixa
    void ucBaixaAC_BaixaInformada(object sender, EventArgs e)
    {
        _ac.RegistrarPagamento(ID_Servidor, 
            Convert.ToDecimal(ucBaixaAC.Valor),
            Convert.ToDateTime(ucBaixaAC.Data),
            ucBaixaAC.NotaFiscal);
        ucBaixaAC.Close();
        _ac = null;
        Bind();
    }

    void ucBaixaAC_OperacaoCancelada(object sender, EventArgs e)
    {
        _ac = null;
    }
    #endregion
    
}
