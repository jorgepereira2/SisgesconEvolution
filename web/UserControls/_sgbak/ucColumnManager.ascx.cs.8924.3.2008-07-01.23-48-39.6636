using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;

public partial class Relatorios_ucColumnManager : System.Web.UI.UserControl
{
    protected void Page_Load(object sender, EventArgs e)
    {
        
    }

    protected override void OnInit(EventArgs e)
    {
        base.OnInit(e);

        RegisterClientScript();
        this.btnAplicar.Click += new EventHandler(btnAplicar_Click);
        btnExportar.Click += new EventHandler(btnExportar_Click);
        btnMarcarTodos.Click += BtnMarcarTodos_OnClick;     
    }

    private void BtnMarcarTodos_OnClick(object sender, EventArgs e)
    {
        gvManager.CheckAll();
        pnManager.UpdateAfterCallBack = true;
    }
    
    void btnExportar_Click(object sender, EventArgs e)
    {
        Control control = this.Page.FindControl(gvManager.GridViewID);
        if(control != null)
            ExportToExcel((WebControl)control , this.Page);
    }

    public void ExportToExcel(WebControl dg, Page page)
    {
        dg.Page.Response.Clear();
        dg.Page.Response.Buffer = true;
        dg.Page.Response.ContentType = "application/vnd.ms-excel";
        dg.Page.Response.Charset = "";
        dg.Page.EnableViewState = false;

        System.IO.StringWriter oStringWriter = new System.IO.StringWriter();
        System.Web.UI.HtmlTextWriter oHtmlTextWriter = new System.Web.UI.HtmlTextWriter(oStringWriter);

        ClearControls(dg);

        Panel pn = new Panel();
        pn.Controls.Add(dg);

        pn.RenderControl(oHtmlTextWriter);

        page.Response.Write(oStringWriter.ToString());


        page.Response.End();
    }

    private void ClearControls(Control control)
    {
        for (int i = control.Controls.Count - 1; i >= 0; i--)
        {
            ClearControls(control.Controls[i]);
        }

        if (!(control is TableCell))
        {
            if (control.GetType().GetProperty("SelectedItem") != null)
            {
                LiteralControl literal = new LiteralControl();
                control.Parent.Controls.Add(literal);
                try
                {
                    literal.Text = (string)control.GetType().GetProperty("SelectedItem").GetValue(control, null);
                }
                catch
                {
                }
                control.Parent.Controls.Remove(control);
            }
            else
                if (control.GetType().GetProperty("Text") != null)
                {
                    LiteralControl literal = new LiteralControl();
                    control.Parent.Controls.Add(literal);
                    literal.Text = (string)control.GetType().GetProperty("Text").GetValue(control, null);
                    control.Parent.Controls.Remove(control);
                }
        }
        return;
    }

    public event EventHandler ColumnsChanged;

    void btnAplicar_Click(object sender, EventArgs e)
    {
        gvManager.UpdateGridView();
        
        if(ColumnsChanged != null)
            ColumnsChanged(this, new EventArgs());
    }
    
    public void SetValues()
    {
        gvManager.SetValues();
    }

    private void RegisterClientScript()
    {
        if(Page.ClientScript.IsClientScriptBlockRegistered("ColumnManager"))
            return;
        
        string script =
            @"
        <script language='javascript'>
        function ShowHideContent(ancora)
        {
            var divContent = document.getElementById('divContent');            
            var divLink = document.getElementById('divLink');
            
            if(divContent.style.display == 'none')
            {
                divContent.style.display = '';
                divLink.style.borderBottomWidth = '1px';
                    
                if(document.all)
                    ancora.innerText = 'Ocultar Opções';
                else
                    ancora.textContent = 'Ocultar Opções';
            }
            else
            {
                divContent.style.display = 'none';
                divLink.style.borderBottomWidth = '0px';
                
                if(document.all)
                    ancora.innerText = 'Mostrar Opções';
                else
                    ancora.textContent = 'Mostrar Opções';
            }
        }
        </script>";
        
        this.Page.ClientScript.RegisterClientScriptBlock(this.GetType(), "ColumnManager", script);
    }
}
